import fs from 'fs';
import util from 'util';
import path from 'path';
import ejs from 'ejs';
import { GearDefinition } from '../models/gear_definition';
import camelcase from 'camelcase';

const writeFile = util.promisify(fs.writeFile);
const renderFile: any = util.promisify(ejs.renderFile);

/**
 * Writes the `gears.dart` file, which contains proxy exports
 * for all the gears generated by the `writeAsDartGearDefinitionInstance`
 * function.
 *
 * @param exports The list of export statements to write
 */
export const writeDartProxyExportFile = async (
  gearDefinitions: GearDefinition[],
  filePath: string,
): Promise<void> => {
  const templateFilePath = path.resolve(
    __dirname,
    '../templates/dart/dart_proxy_export.dart.ejs',
  );

  // Should we just build the camel-cased name into `GearDefinition`? :thinking:
  const gearDefinitionsWithCamelCasedName = gearDefinitions.map((gd) => {
    const camelCasedGearName = camelcase(gd.gearName);
    return { ...gd, camelCasedGearName };
  });

  const rendered = await renderFile(templateFilePath, {
    gearDefinitions: gearDefinitionsWithCamelCasedName,
  });

  await writeFile(filePath, rendered);
};
